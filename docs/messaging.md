# 메시징 시스템 분석

현재 Flitz 앱의 메시징 시스템을 분석하고 기존 데이팅 앱 메시징 기능과 비교하여 부족한 부분을 정리합니다.

## 현재 구현된 기능

현재 Flitz 메시징 시스템은 다음 기능을 제공합니다:

- 1:1 대화 관리
- 텍스트 메시지 전송 및 수신
- 기본적인 이미지 첨부 기능 (다른 첨부 유형은 정의만 되고 구현되지 않음)
- 부적절한 메시지 신고/플래그 시스템
- 메시지 및 대화의 소프트 삭제 (완전히 삭제하지 않고 deleted_at 필드 설정)
- 대화 참여자 단위의 읽음 상태 추적

## 중요 누락 기능

### 1. 메시지 상태 표시
- **현재 상태**: 참여자 수준의 읽음 상태만 추적하며, 개별 메시지 수준의 상태 표시 없음
- **문제점**: 사용자가 특정 메시지가 상대방에게 전송, 전달, 읽음 상태인지 알 수 없음
- **구현 방향**: 
  - `DirectMessage` 모델에 `delivered_at`, `seen_at` 필드 추가
  - 클라이언트가 메시지를 보았을 때 API 엔드포인트를 통해 서버에 알림
  - 상태 변경 시 WebSocket을 통해 발신자에게 알림
- **우선순위**: 높음 (핵심 사용자 경험)

### 2. 실시간 메시징 인프라
- **현재 상태**: 실시간 통신 인프라 없음, REST API 기반의 폴링 방식으로만 동작 가능
- **문제점**: 즉각적인 메시지 전달 및 알림 불가능, 사용자 경험 저하
- **구현 방향**: 
  - Django Channels 통합으로 WebSocket 지원 추가
  - Redis를 메시지 브로커 및 백엔드로 사용
  - 각 사용자를 위한 개별 채널 및 대화별 채널 구조 설계
  - 메시지 실시간 전송 및 상태 업데이트를 위한 이벤트 시스템 구현
- **우선순위**: 높음 (핵심 사용자 경험)

### 3. 타이핑 표시기
- **현재 상태**: 사용자가 메시지를 작성 중임을 표시하는 기능 없음
- **문제점**: 실시간 대화 경험의 자연스러움 감소
- **구현 방향**: 
  - WebSocket을 통한 타이핑 이벤트 전송
  - 타이핑 상태 시작/종료 이벤트 처리
  - 클라이언트 측 입력 감지 및 서버로 상태 전송
- **우선순위**: 중간 (주요 사용자 경험 향상 요소)

### 4. 메시지 반응/이모티콘
- **현재 상태**: 메시지에 대한 반응이나 이모티콘 기능 없음
- **문제점**: 메시지에 대한 간단한 감정 표현이나 승인을 할 수 없음
- **구현 방향**: 
  - `DirectMessageReaction` 모델 생성
  - 반응 유형, 메시지 참조, 사용자 참조 필드 포함
  - 반응 추가/제거를 위한 API 엔드포인트 개발
- **우선순위**: 중간 (사용자 참여도 향상)

### 5. 다양한 미디어 지원
- **현재 상태**: 이미지만 구현되었고, 비디오/오디오는 모델에 정의만 되어 있음
- **문제점**: 사용자가 다양한 형태의 콘텐츠를 공유할 수 없음
- **구현 방향**: 
  - 비디오 및 오디오 첨부 파일 업로드 완성
  - 비디오 미리보기/썸네일 자동 생성
  - 문서, 위치 등 추가 첨부 타입 지원
  - 비디오/오디오 트랜스코딩을 위한 비동기 처리 서비스 구현
- **우선순위**: 높음 (현대 메시징 앱의 기본 기능)

### 6. 메시지 스레딩/답장
- **현재 상태**: 특정 메시지에 직접 답장하는 기능 없음
- **문제점**: 이전 메시지의 맥락을 유지한 대화 흐름을 만들 수 없음
- **구현 방향**: 
  - `DirectMessage` 모델에 `reply_to` 필드 추가 (자기 참조)
  - 원본 메시지 내용의 일부를 미리보기로 포함
  - 원본 메시지로 이동하는 UI 지원
- **우선순위**: 중간 (대화 경험 향상)

### 7. 미디어 메시지 관리
- **현재 상태**: 개별 미디어 첨부 업로드만 가능, 종합적인 관리 기능 부재
- **문제점**: 대화 내 공유된 미디어를 쉽게 찾아보거나 관리할 수 없음
- **구현 방향**: 
  - 대화별 미디어 갤러리 조회 API 엔드포인트 개발
  - 미디어 유형별 필터링 지원
  - 미디어 컬렉션 다운로드 옵션
  - 클라우드 저장소와 CDN 최적화
- **우선순위**: 중간 (사용자 편의성)

### 8. 메시지 알림 시스템
- **현재 상태**: 푸시 알림 시스템과의 명확한 통합 부재
- **문제점**: 사용자가 앱을 열지 않은 상태에서 새 메시지 알림을 받을 수 없음
- **구현 방향**: 
  - Celery 태스크와 APNS/FCM 통합을 통한 메시지 알림 전송
  - 알림 설정 및 관리 기능
  - 중요 대화 및 키워드 기반 알림 필터링
  - 알림 그룹화 및 일괄 처리
- **우선순위**: 매우 높음 (핵심 사용자 경험)

### 9. 오프라인 메시지 처리
- **현재 상태**: 사용자가 오프라인일 때 메시지 처리 전략이 명확하지 않음
- **문제점**: 메시지 배달 보장과 동기화 문제 발생 가능성
- **구현 방향**: 
  - 메시지 큐 시스템 구현
  - 오프라인 시 메시지 저장 및 사용자 접속 시 전달
  - 메시지 배달 확인 메커니즘
  - 다중 기기 간 동기화 지원
- **우선순위**: 높음 (안정성)

### 10. 메시지 검색
- **현재 상태**: GinIndex는 있으나 실제 검색 기능 구현이 없음
- **문제점**: 사용자가 과거 메시지를 키워드로 찾을 수 없음
- **구현 방향**: 
  - 전체 텍스트 검색 API 엔드포인트 개발
  - 날짜, 미디어 유형, 보낸 사람 등 필터링 옵션
  - 검색 결과의 문맥 제공
  - ElasticSearch 통합 고려 (대규모 메시지 처리 시)
- **우선순위**: 중간 (편의 기능)

### 11. 음성/영상 통화 통합
- **현재 상태**: 메시징에서 음성/영상 통화로의 전환 기능 없음
- **문제점**: 대화가 깊어질 때 더 직접적인 소통 방식으로 전환할 수 없음
- **구현 방향**: 
  - WebRTC 또는 타사 통화 서비스(Twilio, Agora 등) 통합
  - 통화 요청, 수락, 거절 API 개발
  - 통화 기록 및 지표 저장
  - 화면 공유 등 추가 기능 고려
- **우선순위**: 낮음 (복잡도가 높으나 초기에는 필수적이지 않음)

### 12. 사용자 상태 표시
- **현재 상태**: 대화 참여자의 온라인/오프라인 상태 표시 기능 없음
- **문제점**: 사용자가 상대방이 현재 활성 상태인지 알 수 없음
- **구현 방향**: 
  - 사용자 상태 추적 시스템 개발
  - 마지막 활동 시간 기록
  - 상태 변경 이벤트 처리
  - "방금 전", "1시간 전" 등의 상대적 시간 표시
- **우선순위**: 중간 (대화 경험 향상)

## 추가 누락 기능

### 임시 메시지 (자동 삭제)
- 설정된 시간 후 자동으로 삭제되는 메시지 기능
- 프라이버시 및 민감한 정보 교환에 유용

### 메시지 편집 및 삭제
- 이미 전송된 메시지 내용 수정 기능
- 양측에서 메시지 삭제 옵션 (자신만, 모두에게)

### 메시지 전달 제한
- 메시지를 다른 대화로 전달하는 기능 제한
- 프라이버시 보호를 위한 설정

### 메시지 예약 전송
- 지정된 시간에 메시지가 자동으로 전송되는 기능

### 그룹 대화 지원
- 현재는 1:1 대화만 지원, 그룹 대화 기능 부재
- 그룹 관리, 멤버 추가/제거, 그룹 정보 등 관련 기능

## 구현 우선순위 및 로드맵

### 1단계 (핵심 기능)
- 메시지 상태 표시 (전송됨, 전달됨, 읽음)
- 실시간 메시징 인프라 (WebSocket)
- 메시지 알림 시스템
- 오프라인 메시지 처리

### 2단계 (사용자 경험 향상)
- 다양한 미디어 지원 (비디오, 오디오 등)
- 타이핑 표시기
- 메시지 스레딩/답장
- 사용자 상태 표시

### 3단계 (고급 기능)
- 메시지 반응/이모티콘
- 미디어 메시지 관리
- 메시지 검색
- 임시 메시지/자동 삭제

### 4단계 (확장 기능)
- 음성/영상 통화 통합
- 그룹 대화 지원
- 메시지 예약 전송
- 고급 프라이버시 기능

## 기술적 고려사항

### 확장성
- 대규모 메시지 처리를 위한 수평적 확장 고려
- 메시지 샤딩 및 파티셔닝 전략
- 읽기/쓰기 분리를 통한 성능 최적화

### 보안
- 종단간 암호화 고려
- 메시지 보존 정책 수립
- 첨부 파일 스캐닝 및 필터링

### 성능
- 메시지 페이징 및 효율적인 로딩 전략
- 미디어 최적화 (압축, 캐싱, CDN)
- 실시간 통신 최적화
